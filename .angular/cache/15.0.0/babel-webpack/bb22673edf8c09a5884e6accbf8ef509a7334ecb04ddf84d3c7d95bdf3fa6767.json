{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2020 gRPC authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ChildLoadBalancerHandler = void 0;\nconst load_balancer_1 = require(\"./load-balancer\");\nconst connectivity_state_1 = require(\"./connectivity-state\");\nconst TYPE_NAME = 'child_load_balancer_helper';\nclass ChildLoadBalancerHandler {\n  constructor(channelControlHelper) {\n    this.channelControlHelper = channelControlHelper;\n    this.currentChild = null;\n    this.pendingChild = null;\n    this.ChildPolicyHelper = class {\n      constructor(parent) {\n        this.parent = parent;\n        this.child = null;\n      }\n      createSubchannel(subchannelAddress, subchannelArgs) {\n        return this.parent.channelControlHelper.createSubchannel(subchannelAddress, subchannelArgs);\n      }\n      updateState(connectivityState, picker) {\n        var _a;\n        if (this.calledByPendingChild()) {\n          if (connectivityState === connectivity_state_1.ConnectivityState.CONNECTING) {\n            return;\n          }\n          (_a = this.parent.currentChild) === null || _a === void 0 ? void 0 : _a.destroy();\n          this.parent.currentChild = this.parent.pendingChild;\n          this.parent.pendingChild = null;\n        } else if (!this.calledByCurrentChild()) {\n          return;\n        }\n        this.parent.channelControlHelper.updateState(connectivityState, picker);\n      }\n      requestReresolution() {\n        var _a;\n        const latestChild = (_a = this.parent.pendingChild) !== null && _a !== void 0 ? _a : this.parent.currentChild;\n        if (this.child === latestChild) {\n          this.parent.channelControlHelper.requestReresolution();\n        }\n      }\n      setChild(newChild) {\n        this.child = newChild;\n      }\n      addChannelzChild(child) {\n        this.parent.channelControlHelper.addChannelzChild(child);\n      }\n      removeChannelzChild(child) {\n        this.parent.channelControlHelper.removeChannelzChild(child);\n      }\n      calledByPendingChild() {\n        return this.child === this.parent.pendingChild;\n      }\n      calledByCurrentChild() {\n        return this.child === this.parent.currentChild;\n      }\n    };\n  }\n  /**\n   * Prerequisites: lbConfig !== null and lbConfig.name is registered\n   * @param addressList\n   * @param lbConfig\n   * @param attributes\n   */\n  updateAddressList(addressList, lbConfig, attributes) {\n    let childToUpdate;\n    if (this.currentChild === null || this.currentChild.getTypeName() !== lbConfig.getLoadBalancerName()) {\n      const newHelper = new this.ChildPolicyHelper(this);\n      const newChild = load_balancer_1.createLoadBalancer(lbConfig, newHelper);\n      newHelper.setChild(newChild);\n      if (this.currentChild === null) {\n        this.currentChild = newChild;\n        childToUpdate = this.currentChild;\n      } else {\n        if (this.pendingChild) {\n          this.pendingChild.destroy();\n        }\n        this.pendingChild = newChild;\n        childToUpdate = this.pendingChild;\n      }\n    } else {\n      if (this.pendingChild === null) {\n        childToUpdate = this.currentChild;\n      } else {\n        childToUpdate = this.pendingChild;\n      }\n    }\n    childToUpdate.updateAddressList(addressList, lbConfig, attributes);\n  }\n  exitIdle() {\n    if (this.currentChild) {\n      this.currentChild.exitIdle();\n      if (this.pendingChild) {\n        this.pendingChild.exitIdle();\n      }\n    }\n  }\n  resetBackoff() {\n    if (this.currentChild) {\n      this.currentChild.resetBackoff();\n      if (this.pendingChild) {\n        this.pendingChild.resetBackoff();\n      }\n    }\n  }\n  destroy() {\n    if (this.currentChild) {\n      this.currentChild.destroy();\n      this.currentChild = null;\n    }\n    if (this.pendingChild) {\n      this.pendingChild.destroy();\n      this.pendingChild = null;\n    }\n  }\n  getTypeName() {\n    return TYPE_NAME;\n  }\n}\nexports.ChildLoadBalancerHandler = ChildLoadBalancerHandler;","map":{"version":3,"names":["Object","defineProperty","exports","value","ChildLoadBalancerHandler","load_balancer_1","require","connectivity_state_1","TYPE_NAME","constructor","channelControlHelper","currentChild","pendingChild","ChildPolicyHelper","parent","child","createSubchannel","subchannelAddress","subchannelArgs","updateState","connectivityState","picker","_a","calledByPendingChild","ConnectivityState","CONNECTING","destroy","calledByCurrentChild","requestReresolution","latestChild","setChild","newChild","addChannelzChild","removeChannelzChild","updateAddressList","addressList","lbConfig","attributes","childToUpdate","getTypeName","getLoadBalancerName","newHelper","createLoadBalancer","exitIdle","resetBackoff"],"sources":["/Users/dimitris.finas/git/lightstep/cloud/aws/angular/angular-tutorial/node_modules/@grpc/grpc-js/build/src/load-balancer-child-handler.js"],"sourcesContent":["\"use strict\";\n/*\n * Copyright 2020 gRPC authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.ChildLoadBalancerHandler = void 0;\nconst load_balancer_1 = require(\"./load-balancer\");\nconst connectivity_state_1 = require(\"./connectivity-state\");\nconst TYPE_NAME = 'child_load_balancer_helper';\nclass ChildLoadBalancerHandler {\n    constructor(channelControlHelper) {\n        this.channelControlHelper = channelControlHelper;\n        this.currentChild = null;\n        this.pendingChild = null;\n        this.ChildPolicyHelper = class {\n            constructor(parent) {\n                this.parent = parent;\n                this.child = null;\n            }\n            createSubchannel(subchannelAddress, subchannelArgs) {\n                return this.parent.channelControlHelper.createSubchannel(subchannelAddress, subchannelArgs);\n            }\n            updateState(connectivityState, picker) {\n                var _a;\n                if (this.calledByPendingChild()) {\n                    if (connectivityState === connectivity_state_1.ConnectivityState.CONNECTING) {\n                        return;\n                    }\n                    (_a = this.parent.currentChild) === null || _a === void 0 ? void 0 : _a.destroy();\n                    this.parent.currentChild = this.parent.pendingChild;\n                    this.parent.pendingChild = null;\n                }\n                else if (!this.calledByCurrentChild()) {\n                    return;\n                }\n                this.parent.channelControlHelper.updateState(connectivityState, picker);\n            }\n            requestReresolution() {\n                var _a;\n                const latestChild = (_a = this.parent.pendingChild) !== null && _a !== void 0 ? _a : this.parent.currentChild;\n                if (this.child === latestChild) {\n                    this.parent.channelControlHelper.requestReresolution();\n                }\n            }\n            setChild(newChild) {\n                this.child = newChild;\n            }\n            addChannelzChild(child) {\n                this.parent.channelControlHelper.addChannelzChild(child);\n            }\n            removeChannelzChild(child) {\n                this.parent.channelControlHelper.removeChannelzChild(child);\n            }\n            calledByPendingChild() {\n                return this.child === this.parent.pendingChild;\n            }\n            calledByCurrentChild() {\n                return this.child === this.parent.currentChild;\n            }\n        };\n    }\n    /**\n     * Prerequisites: lbConfig !== null and lbConfig.name is registered\n     * @param addressList\n     * @param lbConfig\n     * @param attributes\n     */\n    updateAddressList(addressList, lbConfig, attributes) {\n        let childToUpdate;\n        if (this.currentChild === null ||\n            this.currentChild.getTypeName() !== lbConfig.getLoadBalancerName()) {\n            const newHelper = new this.ChildPolicyHelper(this);\n            const newChild = load_balancer_1.createLoadBalancer(lbConfig, newHelper);\n            newHelper.setChild(newChild);\n            if (this.currentChild === null) {\n                this.currentChild = newChild;\n                childToUpdate = this.currentChild;\n            }\n            else {\n                if (this.pendingChild) {\n                    this.pendingChild.destroy();\n                }\n                this.pendingChild = newChild;\n                childToUpdate = this.pendingChild;\n            }\n        }\n        else {\n            if (this.pendingChild === null) {\n                childToUpdate = this.currentChild;\n            }\n            else {\n                childToUpdate = this.pendingChild;\n            }\n        }\n        childToUpdate.updateAddressList(addressList, lbConfig, attributes);\n    }\n    exitIdle() {\n        if (this.currentChild) {\n            this.currentChild.exitIdle();\n            if (this.pendingChild) {\n                this.pendingChild.exitIdle();\n            }\n        }\n    }\n    resetBackoff() {\n        if (this.currentChild) {\n            this.currentChild.resetBackoff();\n            if (this.pendingChild) {\n                this.pendingChild.resetBackoff();\n            }\n        }\n    }\n    destroy() {\n        if (this.currentChild) {\n            this.currentChild.destroy();\n            this.currentChild = null;\n        }\n        if (this.pendingChild) {\n            this.pendingChild.destroy();\n            this.pendingChild = null;\n        }\n    }\n    getTypeName() {\n        return TYPE_NAME;\n    }\n}\nexports.ChildLoadBalancerHandler = ChildLoadBalancerHandler;\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}